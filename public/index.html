<!DOCTYPE html>
<html>
  <head>
    <title>Rj Projects | Video Sync</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.4/slate/bootstrap.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="./css/bootstrap.min.css"> -->
    <!-- <link rel="stylesheet" href="/css/bootstrap-glyphicons.css"> -->
    <link rel="icon" href="/img/Russell-logo.png">
  </head>
  <body>
    <div class="search-header text-center">
      <!-- <img src="/img/Russell-logo.png" alt="my logo"> -->
      <h2>Youtube Realtime Video Sync</h2>
      <div id="usernameWrapper">
        <div id="error"></div>
        <form id="usernameForm">
          <input class="username" id="username" type="text" name="user" placeholder="Enter Username Here...">
          <input class="user-button" type="submit" value="Enter">
        </form>
      </div>

      <!-- <div class="search-content" id="search">
        <form class="" action="#">
          <input class="search-field" type="text" name="search" placeholder="Search Youtube Videos Here...">
          <button class="search-button" type="submit" name="submit">Search</button>
        </form>
      </div> -->

    </div>

    <!-- Where the videos are going to appear -->
    <div id="playerWrapper">
      <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
      <div id="player"></div>
      <div class="bg-primary" id="playerControl">
        <button type="button" class="btn btn-default text-left" aria-label="Left Align" id="playVideo">
          <span class="glyphicon glyphicon-play" aria-hidden="true"></span>
        </button>
        <button type="button" class="btn btn-default text-left" aria-label="Left Align" id="pauseVideo">
          <span class="glyphicon glyphicon-pause" aria-hidden="true"></span>
        </button>
        <div id="progressBar">
          <div id="line"></div>
          <div id="indicator"></div>
        </div>
      </div>
    </div>

    <!-- Users sidebar menu -->
    <div id="userWrapper">
      <div id="cross">&#x2715;</div>
      <h4 class="text-center">Users</h4><hr>
      <div id="users"></div>
    </div>

    <!-- <script src="http://code.jquery.com/jquery-latest.min.js"></script> -->
    <script src="/js/jquery-3.3.1.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <!-- <script src="https://apis.google.com/js/client.js?onload=init"></script> -->
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> -->
    <!-- <script src="/js/myscript.js"></script> -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/embed-player.js"></script>

    <script>
      function progressBarLoop(){
        var socket = io.connect();
        var $progressBar = $('#progressBar');
        var $progressIndicator = $('#indicator');
        var videoLength = player.getDuration();
        $progressBar.click(function(event){
          var divOffset = $(this).offset();
          var seekTo = (event.pageX - divOffset.left)/510*videoLength;
          var mydata = {state: 'play', time: seekTo};
          socket.emit('video event', mydata);
          console.log(seekTo);

          var time = player.getCurrentTime();
          socket.emit('video event', time);
        });
        setInterval(function(){
          if(player == null || progressBar == null){
            return;
          }

          var fraction = player.getCurrentTime()/player.getDuration()*100;
          // console.log(fraction);
          $progressIndicator.css("left", fraction.toString() + "%");
        }, 200);

        // socket.on('event', function(msg){
        //   console.log(msg);
        //   var seekTime = msg/player.getDuration()*100;
        //   $progressIndicator.css('left', seekTime.toString() + '%');
        //   seekTo(msg);
        // });
      }
    </script>

    <script>
      $(document).ready(function(){
        var socket = io.connect();
        var $usernameForm = $('#usernameForm');
        var $users = $('#users');
        var $username = $('#username');
        var $error = $('#error');

        var $playBtn = $('#playVideo');
        var $pauseBtn = $('#pauseVideo');

        // play video event
        $playBtn.click(function(e){
          var play = {state: 'play', time: player.getCurrentTime()};
          socket.emit('video event', play);
        });

        // pause video event
        $pauseBtn.click(function(e){
          var pause = {state: 'pause', time: player.getCurrentTime()};
          socket.emit('video event', pause);
        });

        socket.on('event', function(msg){
          console.log(msg);
          if(msg.state == 'play'){
            if(Math.abs(msg.time - player.getCurrentTime()) > 1){
              seekTo(msg.time);
            }
            playVideo();
          }else if(msg.state == 'pause'){
            pauseVideo();
          }
        });

        // On username form submit
        $usernameForm.submit(function(e){
          e.preventDefault();
          socket.emit('new user', $username.val(), function(data){
            if(data){
              $('#usernameWrapper').hide();
              // $('#search').show();
              $('#playerWrapper').show();
              $('#userWrapper').show();
            }else if(!data){
              $error.html('Please enter a username!');
            }else{
              $error.html('Username is taken');
            }
          });
        });

        // To display online users from the socket
        socket.on('usernames', function(data){
          var html = '';
          for(i=0; i < data.length; i++){
            html += data[i] + '<br>';
          }
          $users.html(html);
        });

        // Function to close the sidebar
        $('#cross').click(function(){
          $('#userWrapper').slideToggle();
        });

      });
    </script>
  </body>
</html>
